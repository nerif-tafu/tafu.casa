version: "3.8"

services:
  traefik:
    image: traefik:v2.10
    command:
      - "--api.insecure=true"  # Enable dashboard in dev
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
    ports:
      - "80:80"   # HTTP
      - "443:443" # HTTPS
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - ./dynamic:/etc/traefik/dynamic:ro
      - ./certificates:/etc/certs:ro

  frontend:
    build:
      context: ../..
      dockerfile: docker/development/frontend.Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`localhost`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.services.frontend.loadbalancer.server.port=9000"
    volumes:
      - ../../:/app
      - /app/node_modules  # Anonymous volume to prevent host mount
    environment:
      - NODE_ENV=development
      - PORT=9000

  backend:
    build:
      context: ../..
      dockerfile: docker/development/backend.Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`localhost`) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls=true"
      - "traefik.http.services.backend.loadbalancer.server.port=9000"
    volumes:
      - ../../:/app
    environment:
      - NODE_ENV=development
      - PORT=9000 